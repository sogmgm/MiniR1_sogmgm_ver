# 1. 작업 디렉토리로 이동
cd /workspace/MiniR1_sogmgm_ver

# 2. 최신 코드 받기 (로컬에서 수정한 내용)
git pull

# 3. HuggingFace 토큰 설정 (처음 한 번만)
export HF_TOKEN="your_token_here"
huggingface-cli login --token $HF_TOKEN

# 4. 환경 확인
uv run python scripts/check_environment.py

# 5. 데이터셋 준비 (새 프롬프트로)
uv run python scripts/dataset_prep.py

# 6. 실행중인 모든 프로세스 종료 및 GPU 메모리 초기화
pkill -f tensorboard
pkill -f train_grpo
pkill -9 -f "python.*train_grpo"
pkill -9 -f "python.*tensorboard"
uv run python -c "import torch; torch.cuda.empty_cache(); torch.cuda.synchronize(); print('✓ GPU memory reset')"

nvidia-smi 

# 7. 기존 로그/체크포인트 삭제 (깨끗한 시작)
rm -rf logs/tensorboard/* checkpoints/* completion_samples/* logs/generation_samples/*

# 8. TensorBoard 실행 (백그라운드)
nohup uv run tensorboard --logdir=logs/tensorboard --port=6006 --host=0.0.0.0 > tensorboard.log 2>&1 &

# 9. 학습 시작 (백그라운드)
nohup uv run python scripts/train_grpo.py --config configs/training_config.yaml > training.log 2>&1 &

# 10. 학습 로그 모니터링
tail -f training.log

# 11. TensorBoard 접속 (로컬 PC에서)
# RunPod 대시보드에서 포트 6006 포워딩 후
# 브라우저: http://localhost:6006

----
<간이 버전 - 완전 초기화>
cd /workspace/MiniR1_sogmgm_ver
pkill -f tensorboard && pkill -f train_grpo && pkill -9 -f "python.*train_grpo" && pkill -9 -f "python.*tensorboard" && \
uv run python scripts/dataset_prep.py && \
rm -rf logs/tensorboard/* checkpoints/* completion_samples/* && \
nohup uv run tensorboard --logdir=logs/tensorboard --port=6006 --host=0.0.0.0 > tensorboard.log 2>&1 & \
nohup uv run python scripts/train_grpo.py --config configs/training_config.yaml > training.log 2>&1 & \
tail -f training.log

# GPU 메모리만 빠르게 초기화
pkill -9 -f "python.*train_grpo" && pkill -9 -f "python.*tensorboard" && nvidia-smi