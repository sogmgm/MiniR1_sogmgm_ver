#############################################
# RunPod 재시작 간단 가이드 (Restart Guide) #
#############################################

목적: Pod 재시작 후 최소 단계로 Mini-R1 학습을 재개하거나 초기화합니다.
실험 환경: NVIDIA A100 80GB 단일 GPU (전체 2000 steps 학습 예상 10~12시간)

---
1) 기본 재시작 (환경 정상, 데이터/체크포인트 유지)
-----------------------------------------------
cd /workspace/MiniR1_sogmgm_ver
source $HOME/.local/bin/env   # UV 환경 로드
git pull                      # 코드 최신화 (필요시)
export HF_TOKEN="your_token_here"  # 첫 실행만
uv run python scripts/check_environment.py

# (선택) GPU 메모리 정리
pkill -f train_grpo || true
pkill -f tensorboard || true
uv run python -c "import torch; torch.cuda.empty_cache(); print('✓ cache cleared')"

# 학습 재개 (가장 최근 체크포인트)
nohup uv run python scripts/train_grpo.py \
	--config configs/training_config.yaml \
	--resume_from_checkpoint checkpoints/qwen2.5-3B/checkpoint-1000 \
	> training.log 2>&1 &

# TensorBoard (로그 디렉토리: training_config.yaml 의 logging_dir)
nohup tensorboard --logdir=logs/tensorboard_qwen2.5-3B_25112 --host=0.0.0.0 --port=6006 > tensorboard.log 2>&1 &
tail -f training.log

---
2) 데이터셋 재생성 필요할 때 (프롬프트 변경 등)
-----------------------------------------------
rm -rf .cache/datasets/
uv run python scripts/dataset_prep.py --config configs/training_config.yaml

# 새 데이터로 처음부터 학습(체크포인트 삭제 권장)
rm -rf checkpoints/qwen2.5-3B/* logs/generation_samples/*
nohup uv run python scripts/train_grpo.py --config configs/training_config.yaml > training.log 2>&1 &
tail -f training.log

---
3) 완전 초기화 올인원(one-liner)
--------------------------------
cd /workspace/MiniR1_sogmgm_ver && \
pkill -f train_grpo || true && pkill -f tensorboard || true && \
uv run python scripts/dataset_prep.py --config configs/training_config.yaml && \
rm -rf checkpoints/qwen2.5-3B/* logs/generation_samples/* && \
nohup tensorboard --logdir=logs/tensorboard_qwen2.5-3B_25112 --host=0.0.0.0 --port=6006 > tensorboard.log 2>&1 & \
nohup uv run python scripts/train_grpo.py --config configs/training_config.yaml > training.log 2>&1 & \
tail -f training.log

---
